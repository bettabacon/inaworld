extends base

block title
  | Play
block header-title
  | Write a Story

block content
  if error
    p.alert.alert-error= error
  form(id='start-story-form')
    p(style='text-align: left')
      span(id='story')
        each word in room.story
          = word
          | 
      | 
      span(id='temporary-word')
      | 
      if user_uid == room.turns[0]
        input(id='word', type='text', name='word', placeholder='Word', autocapitalize='off', autofocus='autofocus', size=5)
      else
        input(id='word', type='text', name='word', placeholder='Word', autocapitalize='off', autofocus='autofocus', size=5, disabled='disabled')
    button(type='submit', class='btn btn-primary') Submit

block scripts
  script.
    (function() {
      var room_uid = '#{room.uid}';
      var writer_uid = '#{user_uid}';
      var waitTime = 0;
      var retry = function(f) {
        setTimeout(f, waitTime);
      };
      $(document).ready(function() {
        var $startStoryForm = $('#start-story-form');
        var $temporaryWord = $('#temporary-word');
        var $word = $('#word');
        var $story = $('#story');
        $startStoryForm.submit(function(e) {
          e.preventDefault();
          var word = $word.val();
          if(word) {
            $temporaryWord.html(word);
            $word.val('');
            $.ajax({
              url: '/api/1/add-word/'+room_uid+'/'+writer_uid+'/', 
              type: 'POST',
              cache: false,
              dataType: 'json',
              data: {
                word: word
              }
            }).done(function(data) {
              if(data.result) {
                if(data.result == 'wrong-turn') {
                  $word.attr('disabled', 'disabled');
                } else {
                  $temporaryWord.html('');
                  $story.html(data.result.story.join(' '));
                  
                  if(data.result.turns[0] == writer_uid) {
                    $word.removeAttr('disabled');
                  } else {
                    $word.attr('disabled', 'disabled');
                  }
                }
              } else {
              
              }
            }).fail(function() {
            
            });
          }
        });
        var checkRoom = function() {            
          $.ajax({
            url: '/api/1/polling/play/'+room_uid+'/', 
            cache: false,
            dataType: 'json'
          }).done(function(data) {
            if(data.result) {
              $story.html(data.result.story.join(' '));
            
              if(data.result.turns[0] == writer_uid) {
                $word.removeAttr('disabled');
              } else {
                $word.attr('disabled', 'disabled');
              }
            }
            retry(checkRoom);
          }).fail(function() {
            retry(checkRoom);
          });
        };
        checkRoom();
      });
    })();
  